///// INTIALIZATION /////
// required modules
const fs = require('fs');
const { config } = require('dotenv');
const { CommandoClient } = require('discord.js-commando');
const path = require('path');
const {getMessageEmotes, replaceMessageEmotes} = require('./events/message.js')
config({path: `${__dirname}/process.env`});

// Commando client
const client = new CommandoClient({
    commandPrefix: process.env.PREFIX,
    owner: process.env.OWNER,
    invite: process.env.INVITE,
    homeguild: process.env.HOMEGUILD,
    disableEveryone: true
});

// register client commands
client.registry
    .registerDefaultTypes()
    .registerGroups([
        ['emote', 'Emote and Reaction Commands'],
        ['wiki', 'Gem Wiki Information'],
        ['test', 'Test Commands'],
    ])
    .registerDefaultGroups()
    .registerDefaultCommands()
    .registerCommandsIn(path.join(__dirname, 'commands'));

// client ready & status
client.once('ready', () => {
    console.log(`Logged in as ${client.user.tag}! (${client.user.id})`);
    client.user.setActivity('OVER THE MOON.', {type: 'WATCHING'})
        .then(presence => console.log(`Activity set to ${presence.activities[0].name}`))
        .catch(console.error);
});

///// CLIENT ON EVENTS /////
// client error event
client.on('error', console.error);


// client read messages
client.on('message', message => {

    // attempt to replace a message with a webhook
    const emotePrefix = '-';
    if (message.content.startsWith(emotePrefix)) {
        getMessageEmotes(message)
            .then(content => {
                if (message.content.slice(1) === content) return;

                let webhook_content = content.replace(/\`/g,'');
                replaceMessageEmotes(message, webhook_content);
            });
    }

    

    

    
});

///// LOG CLIENT INTO DISCORD
client.login(process.env.CLIENT_TOKEN);